{% extends "base.html.j2" %}
{% from "_row.html.j2" import render_row %}

{% block title %}
  {% if periodo %}
    Relatório de Prestação de Contas - {{ periodo }}
  {% else %}
    Relatório de Prestação de Contas
  {% endif %}
{% endblock %}

{% block header_title %}
  {% if periodo %}
    Relatório de Prestação de Contas - {{ periodo }}
  {% else %}
    Relatório de Prestação de Contas
  {% endif %}
{% endblock %}

{% block extra_styles %}
  {% if print_mode %}
    @page { size: A4 portrait; margin: 2cm; }
    body { font-size: 12px; margin: 0; padding: 0; }
    .container { box-shadow: none; border: 1px solid #ccc; }
    h1 { font-size: 18px; }
    .btn-edit, .toggle-payments-btn, #loading-overlay, .modal { display: none !important; }
    table { margin-bottom: 30px; }
    th, td { padding: 4px; }
    .signature { margin-top: 40px; }
    .signature div { display: inline-block; width: 45%; text-align: center; }
  {% endif %}
{% endblock %}

{% block header_buttons %}
  {% if not print_mode %}
    {% if edit_link %}
      <a href="{{ edit_link }}" target="_blank" class="btn-edit">Editar Relatório</a>
    {% endif %}
    {% if print_link %}
      <a href="{{ print_link }}" target="_blank" class="btn-edit">Imprimir</a>
    {% endif %}
  {% endif %}
{% endblock %}

{% block table_head %}
  {% if print_mode %}
    <tr>
      <th>Data</th>
      <th>Descrição</th>
      <th>Receitas (R$)</th>
      <th>Despesas (R$)</th>
      <th>Saldo (R$)</th>
    </tr>
  {% else %}
    {{ super() }}
  {% endif %}
{% endblock %}

{% block table_body %}
  {% if print_mode %}
    {% for row in rows %}
    <tr data-id="{{ row.identificador_unico }}">
      <td>{{ row.data }}</td>
      <td data-field="descricao">{{ row.descricao }}</td>
      <td data-field="receitas">{{ row.receitas }}</td>
      <td data-field="despesas">{{ row.despesas }}</td>
      <td data-field="saldo">{{ row.saldo }}</td>
    </tr>
    {% endfor %}
  {% else %}
    {% for row in rows %}
      {{ render_row(row, loop.index0, attrs, is_editable=true) }}
    {% endfor %}
  {% endif %}
{% endblock %}

{% block extra_scripts %}
  {% if print_mode %}
  <script>
    // JavaScript para edição inline (mantido do código original)
    document.addEventListener('DOMContentLoaded', function() {
      // Tornar células editáveis
      document.querySelectorAll('td[data-field]').forEach(cell => {
        cell.contentEditable = true;
        cell.addEventListener('blur', function() {
          // Salvar alterações quando perder foco
          console.log('Campo editado:', this.getAttribute('data-field'), this.textContent);
        });
      });
      
      // Botão de download
      const downloadBtn = document.getElementById('download-edits');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
          const data = [];
          document.querySelectorAll('tbody tr').forEach(row => {
            const rowData = {
              id: row.getAttribute('data-id'),
              descricao: row.querySelector('[data-field="descricao"]').textContent,
              receitas: row.querySelector('[data-field="receitas"]').textContent,
              despesas: row.querySelector('[data-field="despesas"]').textContent,
              saldo: row.querySelector('[data-field="saldo"]').textContent
            };
            data.push(rowData);
          });
          
          const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'relatorio_editado.json';
          a.click();
          URL.revokeObjectURL(url);
        });
      }
    });
  </script>
  {% endif %}
{% endblock %}

{% block extra_content %}
  {% if print_mode %}
    <button id="download-edits">Salvar</button>
    <div class="signature">
      <div>Local, ___/___/_____<br>Assinatura do Curador</div>
      <div>Data, ___/___/_____<br>Assinatura do Curatelado</div>
    </div>
  {% endif %}
{% endblock %} 